<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Messages</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Chat Header -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="position-relative me-3">
                                <i class="fas fa-user-circle fa-2x text-secondary"></i>
                                <span id="onlineStatus" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary">
                                    <span class="visually-hidden">offline</span>
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-0" id="chatTitle">Chat</h6>
                                <small class="text-muted" id="onlineText">Offline</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="col-12" style="height: calc(100vh - 200px);">
                <div class="card h-100">
                    <div class="card-body p-3 overflow-auto" id="messagesContainer">
                        <!-- Messages will be loaded here -->
                        <div id="loadingSpinner" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-3">
                        <form id="messageForm">
                            <div class="input-group">
                                <input type="file" class="d-none" id="fileInput" multiple>
                                <button class="btn btn-outline-secondary" type="button" id="attachBtn">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <input type="text" class="form-control" id="messageInput" placeholder="Type a message..." autocomplete="off">
                                <button class="btn btn-primary" type="submit" id="sendBtn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                        <!-- File Preview Area -->
                        <div id="filePreview" class="mt-2 d-none"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
class ChatManager {
    constructor() {
        this.chatId = this.getChatIdFromUrl();
        this.socket = null;
        this.messages = [];
        this.currentUser = null;
        this.socketUrl = 'ws://localhost:8000'; // SET YOUR WEBSOCKET URL HERE
        this.apiUrl = '/chat'; // SET YOUR API BASE URL HERE
        
        this.init();
    }

    getChatIdFromUrl() {
        // Extract chat_id from URL - adjust based on your URL structure
        const path = window.location.pathname;
        const match = path.match(/\/chat-page\/(\d+)/);
        return match ? parseInt(match[1]) : null;
    }

    init() {
        this.bindEvents();
        this.loadMessages();
        this.initWebSocket();
    }

    bindEvents() {
        // Message form submission
        document.getElementById('messageForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.sendMessage();
        });

        // File attachment
        document.getElementById('attachBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            this.handleFileSelection(e.target.files);
        });


        // Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
    }

    async loadMessages() {
        if (!this.chatId) {
            console.error('No chat ID found');
            return;
        }

        try {
            const response = await fetch(`${this.apiUrl}/${this.chatId}`);
            const data = await response.json();
            this.messages = data;
            this.renderMessages();
            document.getElementById('loadingSpinner').classList.add('d-none');
        } catch (error) {
            console.error('Error loading messages:', error);
            document.getElementById('loadingSpinner').innerHTML = 
                '<div class="alert alert-danger">Failed to load messages</div>';
        }
    }

    renderMessages() {
        const container = document.getElementById('messagesContainer');
        const spinner = document.getElementById('loadingSpinner');
        
        // Clear existing messages (keep spinner)
        container.innerHTML = '';
        container.appendChild(spinner);

        this.messages.forEach(message => {
            const messageEl = this.createMessageElement(message);
            container.insertBefore(messageEl, spinner);
        });

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    createMessageElement(message) {
        const messageDiv = document.createElement('div');
        const isCurrentUser = message.sender === this.currentUser;
        
        messageDiv.className = `d-flex mb-3 ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}`;
        
        const time = new Date(message.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messageDiv.innerHTML = `
            <div class="message-bubble ${isCurrentUser ? 'bg-primary text-white' : 'bg-white border'} p-3 rounded-3 shadow-sm" style="max-width: 70%;">
                ${!isCurrentUser ? `<div class="fw-bold text-primary mb-1">${message.username}</div>` : ''}
                <div class="message-text">${this.escapeHtml(message.text)}</div>
                <div class="message-time ${isCurrentUser ? 'text-white-50' : 'text-muted'} mt-1" style="font-size: 0.8rem;">
                    ${time}
                    ${message.read ? '<i class="fas fa-check-double ms-1"></i>' : '<i class="fas fa-check ms-1"></i>'}
                </div>
            </div>
        `;
        
        return messageDiv;
    }

    sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const text = messageInput.value.trim();
        
        if (!text && !this.selectedFiles) return;

        const messageData = {
            chat_id: this.chatId,
            text: text,
            sender: this.currentUser
        };

        // Send via WebSocket
        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
            if (this.selectedFiles && this.selectedFiles.length > 0) {
                // Handle file sending
                this.sendFiles(messageData);
            } else {
                this.socket.send(JSON.stringify({
                    type: 'message',
                    data: messageData
                }));
            }
        } else {
            // Fallback to API if WebSocket not available
            this.sendMessageViaAPI(messageData);
        }

        messageInput.value = '';
        this.clearFileSelection();
    }

    async sendMessageViaAPI(messageData) {
        try {
            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(messageData)
            });
            
            const result = await response.json();
            if (result.success) {
                this.loadMessages(); // Refresh messages
            }
        } catch (error) {
            console.error('Error sending message:', error);
        }
    }

    initWebSocket() {
        try {
            this.socket = new WebSocket(`${this.socketUrl}/ws/chat/${this.chatId}/`);
            
            this.socket.onopen = () => {
                console.log('WebSocket connected');
                this.updateConnectionStatus(true);
            };

            this.socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleWebSocketMessage(data);
            };

            this.socket.onclose = () => {
                console.log('WebSocket disconnected');
                this.updateConnectionStatus(false);
                // Attempt to reconnect after 3 seconds
                setTimeout(() => this.initWebSocket(), 3000);
            };

            this.socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        } catch (error) {
            console.error('Failed to initialize WebSocket:', error);
        }
    }

    handleWebSocketMessage(data) {
        switch (data.type) {
            case 'message':
                this.messages.push(data.message);
                this.renderMessages();
                break;
            case 'online_status':
                this.updateOnlineStatus(data.is_online, data.username);
                break;
            case 'typing':
                this.handleTypingIndicator(data);
                break;
            default:
                console.log('Unknown message type:', data.type);
        }
    }

    updateOnlineStatus(isOnline, username) {
        const statusBadge = document.getElementById('onlineStatus');
        const statusText = document.getElementById('onlineText');
        
        if (isOnline) {
            statusBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success';
            statusText.textContent = 'Online';
        } else {
            statusBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary';
            statusText.textContent = 'Offline';
        }
    }

    updateConnectionStatus(connected) {
        // You can add visual indicators for connection status here
        console.log('Connection status:', connected ? 'Connected' : 'Disconnected');
    }

    handleFileSelection(files) {
        this.selectedFiles = Array.from(files);
        this.renderFilePreview();
    }

    renderFilePreview() {
        const preview = document.getElementById('filePreview');
        if (!this.selectedFiles || this.selectedFiles.length === 0) {
            preview.classList.add('d-none');
            return;
        }

        preview.classList.remove('d-none');
        preview.innerHTML = '';

        this.selectedFiles.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'badge bg-secondary me-2 mb-2 p-2';
            fileDiv.innerHTML = `
                ${file.name} (${this.formatFileSize(file.size)})
                <button type="button" class="btn-close btn-close-white ms-2" onclick="chatManager.removeFile(${index})"></button>
            `;
            preview.appendChild(fileDiv);
        });
    }

    removeFile(index) {
        this.selectedFiles.splice(index, 1);
        this.renderFilePreview();
    }

    clearFileSelection() {
        this.selectedFiles = null;
        document.getElementById('fileInput').value = '';
        document.getElementById('filePreview').classList.add('d-none');
    }

    sendFiles(messageData) {
        // Handle file sending via WebSocket
        // You'll need to implement file chunking for large files
        const reader = new FileReader();
        
        this.selectedFiles.forEach(file => {
            reader.onload = (e) => {
                this.socket.send(JSON.stringify({
                    type: 'file',
                    data: {
                        ...messageData,
                        file_name: file.name,
                        file_type: file.type,
                        file_size: file.size,
                        file_data: e.target.result.split(',')[1] // Base64 data
                    }
                }));
            };
            reader.readAsDataURL(file);
        });
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    getCSRFToken() {
        // Get CSRF token from Django
        const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        return token || '';
    }
}

// Initialize chat manager when page loads
let chatManager;
document.addEventListener('DOMContentLoaded', () => {
    chatManager = new ChatManager();
});
    </script>
</body>
</html>