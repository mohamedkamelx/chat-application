<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp - Home</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        .chat-sidebar {
            height: 100vh;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }
        .chat-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-item:hover {
            background-color: #e9ecef;
        }
        .chat-item.active {
            background-color: #0d6efd;
            color: white;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #0056b3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .group-avatar {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }
        .online-dot {
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            position: absolute;
            top: 30px;
            right: 0;
            border: 2px solid white;
        }
        .chat-preview {
            font-size: 0.9em;
            color: #6c757d;
        }
        .chat-time {
            font-size: 0.8em;
            color: #6c757d;
        }
        .unread-badge {
            background-color: #dc3545;
            font-size: 0.7em;
        }
        .welcome-area {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        .search-container {
            position: relative;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .messages-container {
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .message {
            max-width: 70%;
            margin-bottom: 15px;
            word-wrap: break-word;
        }
        .message.sent {
            margin-left: auto;
        }
        .message.received {
            margin-right: auto;
        }
        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }
        .message.sent .message-bubble {
            background-color: #007bff;
            color: white;
        }
        .message.received .message-bubble {
            background-color: white;
            border: 1px solid #e9ecef;
        }
        .message-time {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 5px;
        }
        .message-input-container {
            padding: 15px;
            background-color: white;
            border-top: 1px solid #dee2e6;
        }
        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: #6c757d;
            font-size: 0.9em;
        }
        .online-indicator {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-md-4 col-lg-3 chat-sidebar">
                <!-- Header -->
                <div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">ChatApp</h5>
                        <div class="dropdown">
                                    <form id="logout-form" method="POST" action="{% url 'logout' %}">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item">
                                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                                        </button>
                                    </form>
                        </div>
                    </div>
                    
                    <!-- Search -->
                    <div class="search-container">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" placeholder="Search chats or people..." id="searchInput">
                        </div>
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs border-0 px-3 pt-3" id="chatTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#chats" type="button">Chats</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#groups" type="button">Groups</button>
                    </li>
                </ul>

                <!-- Chat Lists -->
                <div class="tab-content flex-grow-1">
                    <!-- Chats Tab -->
                    <div class="tab-pane fade show active" id="chats">
                        <div class="chat-list" id="chatList">
                            <!-- Chat items will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Groups Tab -->
                    <div class="tab-pane fade" id="groups">
                        <div class="p-3 border-bottom">
                            <button class="btn btn-primary btn-sm w-100" onclick="showCreateGroup()">
                                <i class="bi bi-plus-circle me-2"></i>Create New Group
                            </button>
                        </div>
                        <div class="chat-list" id="groupList">
                            <!-- Group items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-8 col-lg-9">
                <div class="welcome-area" id="welcomeArea">
                    <div class="text-center">
                        <i class="bi bi-chat-dots display-1 text-muted mb-4"></i>
                        <h3 class="text-muted mb-3">Welcome to ChatApp</h3>
                        <p class="text-muted">Select a chat to start messaging</p>
                    </div>
                </div>
                
                <!-- Chat Area (hidden initially) -->
                <div class="d-none" id="chatArea">
                    <!-- Chat Header -->
                    <div class="border-bottom p-3 bg-white">
                        <div class="d-flex align-items-center">
                            <div class="chat-avatar me-3" id="activeChatAvatar">JD</div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0" id="activeChatName">John Doe</h6>
                                <small class="text-muted" id="activeChatStatus">Online</small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-info-circle me-2"></i>Chat Info</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-bell-slash me-2"></i>Mute</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash me-2"></i>Delete Chat</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages Container -->
                    <div class="messages-container" id="messagesContainer">
                        <!-- Messages will be populated here -->
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div class="typing-indicator d-none" id="typingIndicator">
                        Someone is typing...
                    </div>
                    
                    <!-- Message Input -->
                    <div class="message-input-container">
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" title="Attach file">
                                <i class="bi bi-paperclip"></i>
                            </button>
                            <input type="text" class="form-control" placeholder="Type a message..." id="messageInput" onkeypress="handleMessageKeyPress(event)">
                            <button class="btn btn-primary" type="button" onclick="sendMessage()" id="sendButton">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createGroupForm">
                        <div class="mb-3">
                            <label for="groupName" class="form-label">Group Name</label>
                            <input type="text" class="form-control" id="groupName" required>
                        </div>
                        <div class="mb-3">
                            <label for="groupDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="groupDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Add Members</label>
                            <input type="text" class="form-control mb-2" placeholder="Search people..." id="memberSearch">
                            <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="alice" id="member1">
                                    <label class="form-check-label" for="member1">
                                        Alice Johnson
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="bob" id="member2">
                                    <label class="form-check-label" for="member2">
                                        Bob Smith
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="carol" id="member3">
                                    <label class="form-check-label" for="member3">
                                        Carol Williams
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createGroup()">Create Group</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Socket.IO Client Connection (connect to your backend server)
        const socket = io('ws://localhost:3000'); // Replace with your server URL
        
        // Current user and chat state
        let currentUserId = 'user123'; // This would come from your authentication system
        let currentChatId = null;
        let currentChatType = null;
        let messages = {}; // Store messages for each chat/group locally
        
        // Socket.IO Event Listeners
        socket.on('connect', () => {
            console.log('âœ… Connected to chat server');
            // Join user to their personal room for notifications
            socket.emit('join_user_room', currentUserId);
        });
        
        socket.on('disconnect', () => {
            console.log('âŒ Disconnected from chat server');
        });
        
        // Receive new messages
        socket.on('new_message', (messageData) => {
            console.log('ðŸ“¨ New message received:', messageData);
            handleNewMessage(messageData);
        });
        
        // Handle typing indicators
        socket.on('user_typing', (data) => {
            if (data.chatId === currentChatId && data.userId !== currentUserId) {
                showTypingIndicator(data.userName);
            }
        });
        
        socket.on('user_stopped_typing', (data) => {
            if (data.chatId === currentChatId) {
                hideTypingIndicator();
            }
        });
        
        // Handle user online/offline status
        socket.on('user_status_changed', (data) => {
            updateUserStatus(data.userId, data.online);
        });
        
        // Handle message history
        socket.on('chat_history', (data) => {
            loadChatHistory(data);
        });

        // Sample data
        const chats = [
            {
                id: 1,
                name: "John Doe",
                avatar: "JD",
                lastMessage: "Hey, how are you doing?",
                time: "2m ago",
                unread: 2,
                online: true
            },
            {
                id: 2,
                name: "Sarah Wilson",
                avatar: "SW",
                lastMessage: "Can we meet tomorrow?",
                time: "1h ago",
                unread: 0,
                online: true
            },
            {
                id: 3,
                name: "Mike Johnson",
                avatar: "MJ",
                lastMessage: "Thanks for the help!",
                time: "3h ago",
                unread: 1,
                online: false
            },
            {
                id: 4,
                name: "Emma Davis",
                avatar: "ED",
                lastMessage: "See you later!",
                time: "Yesterday",
                unread: 0,
                online: false
            }
        ];

        const groups = [
            {
                id: 1,
                name: "Team Project",
                avatar: "TP",
                lastMessage: "Alice: Meeting at 3 PM",
                time: "30m ago",
                unread: 5,
                members: 8
            },
            {
                id: 2,
                name: "Friends",
                avatar: "FR",
                lastMessage: "Bob: Anyone free tonight?",
                time: "2h ago",
                unread: 0,
                members: 12
            },
            {
                id: 3,
                name: "Study Group",
                avatar: "SG",
                lastMessage: "Carol: Assignment due tomorrow",
                time: "5h ago",
                unread: 3,
                members: 6
            }
        ];

        const searchableUsers = [
            { name: "Alice Johnson", username: "@alice", avatar: "AJ" },
            { name: "Bob Smith", username: "@bob", avatar: "BS" },
            { name: "Carol Williams", username: "@carol", avatar: "CW" },
            { name: "David Brown", username: "@david", avatar: "DB" },
            { name: "Eva Martinez", username: "@eva", avatar: "EM" }
        ];

        // Render chat list
        function renderChats() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = chats.map(chat => `
                <div class="chat-item p-3 border-bottom" onclick="selectChat(${chat.id}, 'chat')">
                    <div class="d-flex align-items-center">
                        <div class="position-relative me-3">
                            <div class="chat-avatar">${chat.avatar}</div>
                            ${chat.online ? '<div class="online-dot"></div>' : ''}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-1">${chat.name}</h6>
                                <div class="d-flex align-items-center">
                                    <small class="chat-time me-2">${chat.time}</small>
                                    ${chat.unread > 0 ? `<span class="badge unread-badge rounded-pill">${chat.unread}</span>` : ''}
                                </div>
                            </div>
                            <p class="mb-0 chat-preview">${chat.lastMessage}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render group list
        function renderGroups() {
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = groups.map(group => `
                <div class="chat-item p-3 border-bottom" onclick="selectChat(${group.id}, 'group')">
                    <div class="d-flex align-items-center">
                        <div class="chat-avatar group-avatar me-3">${group.avatar}</div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${group.name}</h6>
                                    <small class="text-muted">${group.members} members</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <small class="chat-time me-2">${group.time}</small>
                                    ${group.unread > 0 ? `<span class="badge unread-badge rounded-pill">${group.unread}</span>` : ''}
                                </div>
                            </div>
                            <p class="mb-0 chat-preview">${group.lastMessage}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select chat/group (updated with socket integration)
        function selectChat(id, type) {
            // Remove active class from all chat items
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected item
            event.currentTarget.classList.add('active');
            
            // Update current chat state
            currentChatId = id;
            currentChatType = type;
            
            // Join the chat room via socket
            socket.emit('join_chat', { 
                chatId: id, 
                chatType: type, 
                userId: currentUserId 
            });
            
            // Show chat area
            document.getElementById('welcomeArea').classList.add('d-none');
            document.getElementById('chatArea').classList.remove('d-none');
            
            // Update chat header
            const data = type === 'chat' ? chats.find(c => c.id === id) : groups.find(g => g.id === id);
            document.getElementById('activeChatAvatar').textContent = data.avatar;
            document.getElementById('activeChatAvatar').className = `chat-avatar me-3 ${type === 'group' ? 'group-avatar' : ''}`;
            document.getElementById('activeChatName').textContent = data.name;
            document.getElementById('activeChatStatus').textContent = type === 'chat' 
                ? (data.online ? 'Online' : 'Last seen recently') 
                : `${data.members} members`;
            
            // Load messages for this chat
            const chatKey = `${type}_${id}`;
            if (messages[chatKey]) {
                // Display cached messages
                displayMessages(messages[chatKey]);
            } else {
                // Request messages from server
                requestChatHistory(id, type);
            }
            
            // Mark messages as read
            markMessagesAsRead(id, type);
            
            // Focus on message input
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        }
        
        // Handle new incoming message
        function handleNewMessage(messageData) {
            const { chatId, chatType, message, sender } = messageData;
            const chatKey = `${chatType}_${chatId}`;
            
            // Add message to local storage
            if (!messages[chatKey]) messages[chatKey] = [];
            messages[chatKey].push({
                id: message.id,
                content: message.text,
                senderId: sender.id,
                senderName: sender.name,
                timestamp: message.timestamp,
                type: message.type || 'text'
            });
            
            // If this is the current active chat, update the display
            if (chatId === currentChatId && chatType === currentChatType) {
                displayMessages(messages[chatKey]);
                markMessagesAsRead(chatId, chatType);
            } else {
                // Update unread count and chat preview
                updateChatPreview(chatId, chatType, message.text, sender.name);
                incrementUnreadCount(chatId, chatType);
            }
            
            // Play notification sound (optional)
            playNotificationSound();
        }
        
        // Send message function
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChatId) {
                return;
            }
            
            const messageData = {
                chatId: currentChatId,
                chatType: currentChatType,
                message: {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    text: messageText,
                    timestamp: new Date().toISOString(),
                    type: 'text'
                },
                sender: {
                    id: currentUserId,
                    name: 'You' // Replace with actual user name
                }
            };
            
            // Add to local messages immediately (optimistic update)
            const chatKey = `${currentChatType}_${currentChatId}`;
            if (!messages[chatKey]) messages[chatKey] = [];
            messages[chatKey].push({
                id: messageData.message.id,
                content: messageData.message.text,
                senderId: currentUserId,
                senderName: 'You',
                timestamp: messageData.message.timestamp,
                type: 'text'
            });
            
            // Update display immediately
            displayMessages(messages[chatKey]);
            
            // Send to server
            socket.emit('send_message', messageData);
            
            // Clear input and update chat preview
            messageInput.value = '';
            updateChatPreview(currentChatId, currentChatType, messageText, 'You');
            
            console.log('ðŸ“¤ Message sent:', messageData);
        }
        
        // Display messages in chat area
        function displayMessages(messageList) {
            const container = document.getElementById('messagesContainer');
            
            container.innerHTML = messageList.map(msg => {
                const isOwn = msg.senderId === currentUserId;
                const timeStr = formatMessageTime(msg.timestamp);
                
                return `
                    <div class="message ${isOwn ? 'sent' : 'received'}">
                        <div class="message-bubble">
                            ${!isOwn && currentChatType === 'group' ? 
                                `<div class="fw-bold mb-1 text-primary" style="font-size: 0.85em;">${msg.senderName}</div>` : 
                                ''
                            }
                            <div class="message-content">${escapeHtml(msg.content)}</div>
                            <div class="message-time">${timeStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Auto scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        }
        
        // Handle Enter key press for sending messages
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
                stopTyping();
            } else if (event.key !== 'Enter') {
                // Send typing indicator
                startTyping();
            }
        }
        
        // Typing indicator functions
        let typingTimer;
        let isTyping = false;
        
        function startTyping() {
            if (!isTyping && currentChatId) {
                isTyping = true;
                socket.emit('start_typing', {
                    chatId: currentChatId,
                    chatType: currentChatType,
                    userId: currentUserId,
                    userName: 'You' // Replace with actual user name
                });
            }
            
            // Reset the timer
            clearTimeout(typingTimer);
            typingTimer = setTimeout(stopTyping, 2000);
        }
        
        function stopTyping() {
            if (isTyping && currentChatId) {
                isTyping = false;
                socket.emit('stop_typing', {
                    chatId: currentChatId,
                    chatType: currentChatType,
                    userId: currentUserId
                });
            }
            clearTimeout(typingTimer);
        }
        
        // Show/hide typing indicator
        function showTypingIndicator(userName) {
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = `${userName} is typing...`;
            indicator.classList.remove('d-none');
        }
        
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.add('d-none');
        }
        
        // Load chat history when selecting a chat
        function loadChatHistory(data) {
            const { chatId, chatType, messages: historyMessages } = data;
            const chatKey = `${chatType}_${chatId}`;
            
            // Store messages locally
            messages[chatKey] = historyMessages.map(msg => ({
                id: msg.id,
                content: msg.text,
                senderId: msg.sender.id,
                senderName: msg.sender.name,
                timestamp: msg.timestamp,
                type: msg.type || 'text'
            }));
            
            // If this is the current chat, display messages
            if (chatId === currentChatId && chatType === currentChatType) {
                displayMessages(messages[chatKey]);
            }
        }
        
        // Request chat history from server
        function requestChatHistory(chatId, chatType) {
            socket.emit('get_chat_history', {
                chatId: chatId,
                chatType: chatType,
                userId: currentUserId
            });
        }
        
        // Mark messages as read
        function markMessagesAsRead(chatId, chatType) {
            socket.emit('mark_messages_read', {
                chatId: chatId,
                chatType: chatType,
                userId: currentUserId
            });
            
            // Reset unread count locally
            const list = chatType === 'chat' ? chats : groups;
            const item = list.find(item => item.id === chatId);
            if (item) {
                item.unread = 0;
                if (chatType === 'chat') {
                    renderChats();
                } else {
                    renderGroups();
                }
            }
        }
        
        // Update user online status
        function updateUserStatus(userId, isOnline) {
            const chat = chats.find(c => c.userId === userId);
            if (chat) {
                chat.online = isOnline;
                renderChats();
                
                // Update current chat status if viewing this user
                if (currentChatId && currentChatType === 'chat') {
                    const currentChat = chats.find(c => c.id === currentChatId);
                    if (currentChat && currentChat.userId === userId) {
                        const statusEl = document.getElementById('activeChatStatus');
                        statusEl.textContent = isOnline ? 'Online' : 'Last seen recently';
                        statusEl.className = isOnline ? 'text-success' : 'text-muted';
                    }
                }
            }
        }
        
        // Utility functions
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'now';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays < 7) return `${diffDays}d`;
            
            return date.toLocaleDateString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function incrementUnreadCount(chatId, chatType) {
            const list = chatType === 'chat' ? chats : groups;
            const item = list.find(item => item.id === chatId);
            if (item) {
                item.unread = (item.unread || 0) + 1;
                if (chatType === 'chat') {
                    renderChats();
                } else {
                    renderGroups();
                }
            }
        }
        
        function playNotificationSound() {
            // Optional: Play notification sound
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmweBjqX2+/AdiQELIfM8NeBOAgSabLq5I1NDBFMpeHvyXApBiGU3+q+eimGneSzt2QdBzeV2+7VBT2EqPvXeywgI'); 
                audio.volume = 0.3;
                audio.play().catch(() => {}); // Ignore errors if sound fails
            } catch (e) {
                // Ignore sound errors
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (query.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            
            const filteredUsers = searchableUsers.filter(user => 
                user.name.toLowerCase().includes(query) || 
                user.username.toLowerCase().includes(query)
            );
            
            if (filteredUsers.length > 0) {
                searchResults.innerHTML = filteredUsers.map(user => `
                    <div class="search-result-item" onclick="startChat('${user.name}', '${user.avatar}')">
                        <div class="d-flex align-items-center">
                            <div class="chat-avatar me-3" style="width: 30px; height: 30px; font-size: 0.8em;">${user.avatar}</div>
                            <div>
                                <div class="fw-medium">${user.name}</div>
                                <small class="text-muted">${user.username}</small>
                            </div>
                        </div>
                    </div>
                `).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<div class="search-result-item text-muted">No users found</div>';
                searchResults.style.display = 'block';
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        // Start new chat
        function startChat(name, avatar) {
            // Add to chats list (in real app, this would be handled by backend)
            const newChat = {
                id: chats.length + 1,
                name: name,
                avatar: avatar,
                lastMessage: "Say hello!",
                time: "now",
                unread: 0,
                online: true
            };
            chats.unshift(newChat);
            renderChats();
            
            // Clear search
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            
            // Switch to chats tab and select new chat
            document.querySelector('[data-bs-target="#chats"]').click();
            setTimeout(() => selectChat(newChat.id, 'chat'), 100);
        }

        // Show create group modal
        function showCreateGroup() {
            const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
            modal.show();
        }

        // Create group
        function createGroup() {
            const groupName = document.getElementById('groupName').value;
            const groupDescription = document.getElementById('groupDescription').value;
            const selectedMembers = Array.from(document.querySelectorAll('#createGroupModal input[type="checkbox"]:checked'));
            
            if (!groupName.trim()) {
                alert('Please enter a group name');
                return;
            }
            
            // Create new group (in real app, this would be handled by backend)
            const newGroup = {
                id: groups.length + 1,
                name: groupName,
                avatar: groupName.substring(0, 2).toUpperCase(),
                lastMessage: "Group created",
                time: "now",
                unread: 0,
                members: selectedMembers.length + 1 // +1 for current user
            };
            groups.unshift(newGroup);
            renderGroups();
            
            // Close modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('createGroupModal')).hide();
            document.getElementById('createGroupForm').reset();
            
            // Switch to groups tab and select new group
            document.querySelector('[data-bs-target="#groups"]').click();
            setTimeout(() => selectChat(newGroup.id, 'group'), 100);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderChats();
            renderGroups();
        });
    </script>
</body>
</html>